name: Deploy to Fly.io

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pinned flyctl
        run: |
          curl -sL https://github.com/superfly/flyctl/releases/download/v0.2.117/flyctl_0.2.117_Linux_x86_64.tar.gz -o flyctl.tgz
          tar -xzf flyctl.tgz
          sudo mv flyctl /usr/local/bin/flyctl
          flyctl version

      - name: Deploy app
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          FLY_NONINTERACTIVE: 1
        run: |
          # Ensure app exists (ignore error if exists)
          flyctl apps create flask-pgvcl-billpay --org personal || true
          # Simple deploy using repo's fly.toml (Machines v2)
          flyctl deploy --remote-only --config fly.toml --app flask-pgvcl-billpay
